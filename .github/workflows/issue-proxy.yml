name: Issue Proxy via Git Commit

on:
  push:
    branches:
      - 'issue-proxy'      # 人間用: 固定ブランチ
      - 'claude/issue-*'   # Claude用: issue-で始まるブランチ

jobs:
  create-issue:
    runs-on: ubuntu-latest
    if: startsWith(github.event.head_commit.message, 'issue:')

    permissions:
      issues: write
      contents: write  # ブランチ削除のために必要

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse commit message and create issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          COMMIT_EMAIL: ${{ github.event.head_commit.author.email }}
          COMMIT_TIMESTAMP: ${{ github.event.head_commit.timestamp }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          # Extract title (remove 'issue:' prefix and trim)
          TITLE=$(echo "$COMMIT_MESSAGE" | head -n 1 | sed 's/^issue:[[:space:]]*//')

          # Extract body (everything after the first line, if exists)
          BODY=$(echo "$COMMIT_MESSAGE" | tail -n +2)

          # If no body provided, use commit details
          if [ -z "$BODY" ]; then
            BODY=$(cat <<EOF
          Created via Issue Proxy workflow

          **Commit Details:**
          - SHA: ${COMMIT_SHA}
          - Author: ${COMMIT_AUTHOR} <${COMMIT_EMAIL}>
          - Timestamp: ${COMMIT_TIMESTAMP}
          - Branch: ${BRANCH_NAME}
          EOF
          )
          fi

          # Create the issue
          echo "Creating issue with title: $TITLE"
          gh issue create --title "$TITLE" --body "$BODY"

          echo "Issue created successfully!"

      - name: Delete branch after issue creation
        if: startsWith(github.ref_name, 'claude/issue-')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          echo "Deleting branch: $BRANCH_NAME"
          git push origin --delete "$BRANCH_NAME" || echo "Branch deletion failed (may already be deleted)"
          echo "Branch cleanup completed!"
